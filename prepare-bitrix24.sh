#!/bin/bash

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–≤–æ–¥–∞
print_header() {
    echo -e "${BLUE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Activity –¥–ª—è Bitrix24              ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
}

print_step() {
    echo -e "${YELLOW}[–®–ê–ì]${NC} $1"
}

print_success() {
    echo -e "${GREEN}‚úÖ${NC} $1"
}

print_error() {
    echo -e "${RED}‚ùå${NC} $1"
}

print_info() {
    echo -e "${BLUE}‚ÑπÔ∏è${NC} $1"
}

print_header

print_step "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ Activity –¥–ª—è Bitrix24..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–∞–ø–∫–∏ Activity
if [ ! -d "src/activity/telegram_approval" ]; then
    print_error "–ü–∞–ø–∫–∞ Activity –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
EXPORT_DIR="bitrix24_activity_export"
print_info "–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞: $EXPORT_DIR"

if [ -d "$EXPORT_DIR" ]; then
    rm -rf "$EXPORT_DIR"
fi

mkdir -p "$EXPORT_DIR"

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã Activity
print_info "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ Activity..."
cp -r src/activity/telegram_approval "$EXPORT_DIR/"

# –°–æ–∑–¥–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
print_info "–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ..."

cat > "$EXPORT_DIR/INSTALL_INSTRUCTIONS.txt" << 'EOF'
üìã –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –£–°–¢–ê–ù–û–í–ö–ï ACTIVITY –í BITRIX24

üéØ –ß—Ç–æ –¥–µ–ª–∞—Ç—å:
1. –í–æ–π–¥–∏—Ç–µ –≤ –≤–∞—à Bitrix24 –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã ‚Üí –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏ –¥–µ–π—Å—Ç–≤–∏—è
3. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ" –∏–ª–∏ "–ó–∞–≥—Ä—É–∑–∏—Ç—å"
4. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª include.php –∏–∑ —ç—Ç–æ–π –ø–∞–ø–∫–∏
5. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª

üìÅ –§–∞–π–ª—ã –≤ —ç—Ç–æ–π –ø–∞–ø–∫–µ:
- include.php - –≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª Activity
- install/ - —Ñ–∞–π–ª—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏
- lang/ - –ø–µ—Ä–µ–≤–æ–¥—ã
- lib/ - –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

‚öôÔ∏è –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
3. –î–æ–±–∞–≤—å—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ "Telegram Approval"
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Activity:
- URL —Å–µ—Ä–≤–µ—Ä–∞: http://localhost:3000 (–≤–∞—à –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä)
- –ü–æ–ª—É—á–∞—Ç–µ–ª–∏: –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –¢–∞–π–º–∞—É—Ç: –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 24 —á–∞—Å–∞)

‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞:
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏—à–ª–æ –≤ Telegram
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ—Ç–≤–µ—Ç –≤–µ—Ä–Ω—É–ª—Å—è –≤ Bitrix24

üÜò –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω: ./scripts/status.sh
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ URL –≤ Activity
- –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –≤ Bitrix24

üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞:
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: docs/
- –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã: ./scripts/status.sh
- –õ–æ–≥–∏: src/backend/logs/
EOF

# –°–æ–∑–¥–∞–µ–º README
cat > "$EXPORT_DIR/README.md" << 'EOF'
# Telegram Approval Activity –¥–ª—è Bitrix24

## –û–ø–∏—Å–∞–Ω–∏–µ
Activity –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram Bot.

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞
1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª `include.php` –≤ Bitrix24 —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
2. –ò–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Å—é –ø–∞–ø–∫—É –≤ `/bitrix/activities/custom/` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
1. –î–æ–±–∞–≤—å—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ "Telegram Approval" –≤ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Backend-—Å–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:3000
- Telegram Bot –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- Webhook –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞
–°–º. —Ñ–∞–π–ª INSTALL_INSTRUCTIONS.txt –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
EOF

print_success "–§–∞–π–ª—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
print_info "–ü–∞–ø–∫–∞ —Å —Ñ–∞–π–ª–∞–º–∏: $EXPORT_DIR"

echo ""
print_info "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–ø–∫—É: $EXPORT_DIR"
echo "2. –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ: INSTALL_INSTRUCTIONS.txt"
echo "3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ include.php –≤ –≤–∞—à Bitrix24"
echo "4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å"

echo ""
print_info "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:"
tree "$EXPORT_DIR" 2>/dev/null || ls -la "$EXPORT_DIR"

echo ""
print_success "–ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å Activity –≤ Bitrix24!"
