# Техническое задание (ТЗ)
## Проект: Кастомное Activity «Согласование через Telegram» для бизнес-процессов Битрикс24 (коробка)

---

## 1. Общая информация
**Цель:**  
Реализовать кастомное действие (Activity) для конструктора бизнес-процессов коробочной версии Битрикс24, которое позволяет отправлять запрос на согласование в Telegram и возвращать результат в процесс.

**Ключевые особенности:**
- Настройка текста сообщения и кнопок прямо в Activity.
- Поддержка подстановок из документа и предыдущих шагов.
- Возможность работы с одним или несколькими согласантами.
- Ответ возможен кнопкой или текстовым сообщением в Telegram.
- Результат возвращается в бизнес-процесс и используется в дальнейших шагах.

---

## 2. Сценарий работы
1. Пользователь запускает бизнес-процесс в Битрикс24.  
2. На шаге «Согласование через Telegram»:
   - формируется сообщение,
   - добавляются кнопки (тексты задаются в настройках Activity),
   - определяется список согласантов.
3. Сообщение отправляется согласанту(ам) в Telegram.  
4. Согласант отвечает:
   - нажатием кнопки (inline) или
   - текстом («Согласовано» / «Не согласовано»).
5. Результат фиксируется:
   - статус (approve/reject),
   - подпись выбранной кнопки,
   - комментарий (если был текстовый ответ),
   - кто ответил,
   - время ответа.
6. Activity возвращает результат в процесс.  
7. Бизнес-процесс ветвится по результату (например, «если approve → продолжить», «если reject → завершить»).

---

## 3. Требования к функционалу

### 3.1. В дизайнере БП
Activity «Согласование через Telegram» должно иметь следующие настройки:
- **Согласант(ы)**: выбор пользователей Битрикс24 (один или несколько).
- **Текст сообщения**: поддержка подстановок (`{=Document:ID}`, `{=Activity:Result}`).
- **Подписи кнопок** (динамические, до 2 кнопок минимум):
  - Кнопка 1: подпись + код (`approve`).
  - Кнопка 2: подпись + код (`reject`).
- **Режим работы с несколькими согласантами**:
  - Ждать ответа всех.
  - Достаточно первого ответа.
- (опц.) **Обработка таймаута**: авто-отклонение / авто-согласование / ничего.

### 3.2. В Telegram
- Сообщение с текстом и inline-кнопками.  
- Возможность ответить текстом вместо кнопки.  
- После ответа сообщение редактируется:  Статус: ✅ Согласовано (Иван Иванов, 12:34)
- При нескольких согласантах: отображение статусов по каждому.

### 3.3. В Битрикс24
Activity должно возвращать результаты, доступные через «Получить результат»:
- `RESULT_CODE` — код ответа (`approve` / `reject`).
- `RESULT_LABEL` — фактическая подпись кнопки.
- `COMMENT` — текст ответа (если был).
- `RESPONDED_BY` — кто ответил (ФИО / Telegram ID).
- `RESPONDED_AT` — дата и время ответа.

---

## 4. Архитектура решения

### 4.1. Компоненты
1. **Activity (PHP-модуль для коробки):**
 - форма настроек в дизайнере,
 - выполнение: вызов backend-сервиса,
 - ожидание внешнего события (`OnExternalEvent`),
 - возврат результата.

2. **Backend-сервис (размещается на сервере Бигет):**
 - принимает запросы от Activity,
 - отправляет сообщения в Telegram Bot API,
 - принимает webhook’и от Telegram,
 - проверяет корректность пользователя (B24 user ↔ Telegram ID),
 - вызывает `OnExternalEvent` в Битрикс24,
 - сохраняет результаты.

3. **Telegram Bot:**
 - зарегистрирован через BotFather,
 - подключен к backend-сервису через webhook,
 - отправка сообщений, кнопки, приём текстовых ответов.

### 4.2. Логика
- **Из БП:** Activity вызывает сервис → сервис отправляет сообщение в Telegram.  
- **Из Telegram:** ответ приходит в сервис → сервис проверяет пользователя → дергает `OnExternalEvent` → завершает Activity → результат доступен в БП.  

---

## 5. Нефункциональные требования
- **Безопасность:**
- Проверка Telegram ID и соответствия пользователю Б24.
- Подпись запросов между Activity и сервисом.
- **Надёжность:**
- Защита от повторных ответов.
- Логирование всех запросов/ответов.
- **Ограничения:**
- `callback_data` в Telegram ≤ 64 байт (только коды и ID).
- Поддержка русского языка (мультиязычность не требуется).

---

## 6. Этапы разработки
1. Анализ и детализация требований.  
2. Разработка Activity для коробки.  
3. Разработка backend-сервиса и интеграции с Telegram Bot API.  
4. Интеграция Activity ↔ сервис ↔ Telegram.  
5. Тестирование:
 - один согласант,
 - несколько согласантов,
 - конфликтные ответы («один за», «другой против»),
 - текстовые ответы,
 - повторные нажатия.
6. Документация:
 - инструкция по установке модуля,
 - инструкция по настройке в БП,
 - инструкция по работе с Telegram-ботом.
7. Внедрение и обучение.

---

## 7. Риски
- Несоответствие пользователей Б24 и Telegram (нужно поддерживать справочник ID).  
- Потеря связи с сервисом (необходимы повторные попытки).  
- Конфликтные ответы при нескольких согласантах (нужно определить политику обработки).  

---

## 8. Открытые вопросы
1. При нескольких согласантах:
 - нужно ждать всех или достаточно первого?  
 - как трактовать разные мнения («один согласовал, другой отклонил»)?  
2. Формат текстовых ответов:
 - строго по ключевым словам («Согласовано», «Не согласовано») или  
 - любой текст → фиксируем как `COMMENT`, а решение принимается только по кнопкам?  
3. Backend-сервис:
 - реализовать на PHP (нативно для Бигета) или на Node.js (удобнее для Telegram Bot API)?  
4. Тестирование:
 - кто отвечает за внутреннее тестирование процессов в портале (ваша команда или разработчик)?

---
